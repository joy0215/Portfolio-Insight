// frontend/src/app/market/page.tsx
'use client'

import { useState, useEffect } from 'react'
import { TrendingUp, TrendingDown, Activity, BarChart3, RefreshCw, AlertCircle } from 'lucide-react'
import Layout from '@/components/layout/Layout'
import Card from '@/components/ui/Card'
import Button from '@/components/ui/Button'

interface StockData {
  symbol: string
  name: string
  current_price: number
  change: number
  change_percent: number
  volume: number
  exchange?: string
  sector?: string
  data_source?: string
  last_updated?: string
}

interface MarketData {
  stocks?: StockData[]
  market_status?: string
  last_updated?: string
  data_source?: string
  total_stocks?: number
}

export default function MarketPage() {
  const [mounted, setMounted] = useState(false)
  const [marketData, setMarketData] = useState<MarketData>({})
  const [loading, setLoading] = useState(true)
  const [error, setError] = useState<string | null>(null)
  const [lastUpdated, setLastUpdated] = useState<string>('')
  const [currentTime, setCurrentTime] = useState<string>('')
  const [autoRefresh, setAutoRefresh] = useState(false)
  const [refreshInterval, setRefreshInterval] = useState<NodeJS.Timeout | null>(null)
  const [selectedRegion, setSelectedRegion] = useState<string>('ALL')
  const [sortBy, setSortBy] = useState<'symbol' | 'change_percent' | 'volume'>('change_percent')
  const [sortOrder, setSortOrder] = useState<'asc' | 'desc'>('desc')
  const [debugInfo, setDebugInfo] = useState<any>({})

  const regions = [
    { value: 'ALL', label: 'ÂÖ®Â∏ÇÂ†¥', flag: 'üåç' },
    { value: 'US', label: 'ÁæéËÇ°', flag: 'üá∫üá∏' },
    { value: 'TW', label: 'Âè∞ËÇ°', flag: 'üáπüáº' },
    { value: 'HK', label: 'Ê∏ØËÇ°', flag: 'üá≠üá∞' },
  ]

  // ‰øÆÂæ© hydration ÂïèÈ°å
  useEffect(() => {
    setMounted(true)
    updateCurrentTime()
    
    // ÊØèÁßíÊõ¥Êñ∞ÊôÇÈñì
    const timer = setInterval(updateCurrentTime, 1000)
    
    // ÂàùÂßãÂåñÊôÇÁ´ãÂç≥Âä†ËºâÊï∏Êìö
    setTimeout(() => {
      fetchMarketData()
    }, 100)
    
    return () => {
      clearInterval(timer)
      if (refreshInterval) {
        clearInterval(refreshInterval)
      }
    }
  }, [])

  // Ëá™ÂãïÂà∑Êñ∞ÂäüËÉΩ
  useEffect(() => {
    if (autoRefresh && mounted) {
      const interval = setInterval(() => {
        fetchMarketData(true) // ÈùúÈªòÂà∑Êñ∞
      }, 30000) // 30ÁßíÂà∑Êñ∞‰∏ÄÊ¨°
      
      setRefreshInterval(interval)
      
      return () => {
        if (interval) {
          clearInterval(interval)
        }
      }
    } else {
      if (refreshInterval) {
        clearInterval(refreshInterval)
        setRefreshInterval(null)
      }
    }
  }, [autoRefresh, mounted])

  const updateCurrentTime = () => {
    const now = new Date()
    setCurrentTime(now.toLocaleString('zh-TW', {
      year: 'numeric',
      month: '2-digit',
      day: '2-digit',
      hour: '2-digit',
      minute: '2-digit',
      second: '2-digit',
      hour12: false
    }))
  }

  const fetchMarketData = async (silent: boolean = false) => {
    try {
      if (!silent) {
        setLoading(true)
        setError(null)
        setDebugInfo({})
      }
      
      console.log('üîÑ ÈñãÂßãÁç≤ÂèñÂ∏ÇÂ†¥Êï∏Êìö...')
      
      const apiUrl = process.env.NEXT_PUBLIC_API_URL || 'http://localhost:8000'
      
      // Êõ¥Êñ∞Ë™øË©¶‰ø°ÊÅØ
      setDebugInfo(prev => ({
        ...prev,
        apiUrl,
        timestamp: new Date().toISOString(),
        attempt: (prev.attempt || 0) + 1
      }))
      
      // È¶ñÂÖàÊ∏¨Ë©¶ÂæåÁ´ØÈÄ£Êé•
      console.log('üì° Ê∏¨Ë©¶ÂæåÁ´ØÈÄ£Êé•...')
      
      let healthResponse
      try {
        healthResponse = await fetch(`${apiUrl}/api/portfolios/health/`, {
          method: 'GET',
          headers: {
            'Accept': 'application/json',
            'Content-Type': 'application/json',
          },
          cache: 'no-cache',
        })
      } catch (fetchError) {
        console.error('‚ùå Á∂≤Áµ°ÈÄ£Êé•Â§±Êïó:', fetchError)
        throw new Error(`ÁÑ°Ê≥ïÈÄ£Êé•Âà∞ÂæåÁ´ØÊúçÂãô (${apiUrl}): ${fetchError instanceof Error ? fetchError.message : 'Á∂≤Áµ°ÈåØË™§'}`)
      }
      
      if (!healthResponse.ok) {
        throw new Error(`ÂæåÁ´ØÂÅ•Â∫∑Ê™¢Êü•Â§±Êïó (HTTP ${healthResponse.status})`)
      }
      
      const healthData = await healthResponse.json()
      console.log('‚úÖ ÂæåÁ´ØÈÄ£Êé•Ê≠£Â∏∏:', healthData)
      
      setDebugInfo(prev => ({
        ...prev,
        healthCheck: 'success',
        backendStatus: healthData
      }))
      
      // Áç≤ÂèñÂ∏ÇÂ†¥Á∏ΩË¶Ω
      console.log('üìä Áç≤ÂèñÂ∏ÇÂ†¥Êï∏Êìö...')
      
      let marketResponse
      try {
        marketResponse = await fetch(`${apiUrl}/api/portfolios/market-overview/`, {
          method: 'GET',
          headers: {
            'Accept': 'application/json',
            'Content-Type': 'application/json',
          },
          cache: 'no-cache',
        })
      } catch (fetchError) {
        console.error('‚ùå Â∏ÇÂ†¥Êï∏ÊìöË´ãÊ±ÇÂ§±Êïó:', fetchError)
        throw new Error(`Â∏ÇÂ†¥Êï∏ÊìöË´ãÊ±ÇÂ§±Êïó: ${fetchError instanceof Error ? fetchError.message : 'Á∂≤Áµ°ÈåØË™§'}`)
      }
      
      if (!marketResponse.ok) {
        const errorText = await marketResponse.text()
        console.error('‚ùå Â∏ÇÂ†¥Êï∏Êìö API ÈåØË™§:', errorText)
        throw new Error(`Â∏ÇÂ†¥Êï∏Êìö API ÈåØË™§ (HTTP ${marketResponse.status}): ${errorText}`)
      }
      
      const data = await marketResponse.json()
      console.log('üìä Â∏ÇÂ†¥Êï∏Êìö:', data)
      
      setDebugInfo(prev => ({
        ...prev,
        marketDataFetch: 'success',
        dataReceived: {
          hasStocks: !!data.stocks,
          stockCount: data.stocks?.length || 0,
          dataSource: data.data_source
        }
      }))
      
      // Â¶ÇÊûúÊ≤íÊúâËÇ°Á•®Êï∏ÊìöÔºå‰ΩøÁî®Ê®°Êì¨Êï∏Êìö
      if (!data.stocks || data.stocks.length === 0) {
        console.log('‚ö†Ô∏è ÂæåÁ´ØÊ≤íÊúâËøîÂõûËÇ°Á•®Êï∏ÊìöÔºå‰ΩøÁî®Ê®°Êì¨Êï∏Êìö')
        const mockData = {
          stocks: generateMockStocks(),
          market_status: 'Mock Data',
          data_source: 'Â¢ûÂº∑ÂûãÊ®°Êì¨Êï∏Êìö (ÂæåÁ´ØÁÑ°Êï∏Êìö)',
          total_stocks: 12
        }
        
        processMarketData(mockData, silent)
        return
      }
      
      // ËôïÁêÜÁúüÂØ¶Êï∏Êìö
      processMarketData(data, silent)
      
    } catch (err) {
      console.error('‚ùå Áç≤ÂèñÂ∏ÇÂ†¥Êï∏ÊìöÂ§±Êïó:', err)
      const errorMessage = err instanceof Error ? err.message : 'Êú™Áü•ÈåØË™§'
      
      setDebugInfo(prev => ({
        ...prev,
        error: errorMessage,
        errorType: err instanceof Error ? err.constructor.name : 'Unknown'
      }))
      
      if (!silent) {
        setError(errorMessage)
        
        // Ë®≠ÁΩÆÊ®°Êì¨Êï∏Êìö‰ΩúÁÇ∫ÈôçÁ¥ö
        console.log('üîÑ ‰ΩøÁî®Ê®°Êì¨Êï∏Êìö‰ΩúÁÇ∫ÈôçÁ¥öÊñπÊ°à')
        const mockData = {
          stocks: generateMockStocks(),
          market_status: 'Mock Data',
          data_source: 'Â¢ûÂº∑ÂûãÊ®°Êì¨Êï∏Êìö (API ÈÄ£Êé•Â§±Êïó)',
          total_stocks: 12
        }
        
        processMarketData(mockData, silent)
      }
      
    } finally {
      if (!silent) {
        setLoading(false)
      }
    }
  }

  const processMarketData = (data: any, silent: boolean) => {
    // ÈÅéÊøæÂú∞ÂçÄÊï∏Êìö
    let filteredStocks = data.stocks || []
    if (selectedRegion !== 'ALL') {
      filteredStocks = filteredStocks.filter((stock: StockData) => {
        switch (selectedRegion) {
          case 'US':
            return !stock.symbol.includes('.TW') && !stock.symbol.includes('.HK')
          case 'TW':
            return stock.symbol.includes('.TW')
          case 'HK':
            return stock.symbol.includes('.HK')
          default:
            return true
        }
      })
    }
    
    // ÊéíÂ∫èÊï∏Êìö
    filteredStocks.sort((a: StockData, b: StockData) => {
      let aValue, bValue
      switch (sortBy) {
        case 'symbol':
          aValue = a.symbol
          bValue = b.symbol
          break
        case 'change_percent':
          aValue = a.change_percent
          bValue = b.change_percent
          break
        case 'volume':
          aValue = a.volume
          bValue = b.volume
          break
        default:
          aValue = a.change_percent
          bValue = b.change_percent
      }
      
      if (sortOrder === 'asc') {
        return aValue > bValue ? 1 : -1
      } else {
        return aValue < bValue ? 1 : -1
      }
    })
    
    setMarketData({
      ...data,
      stocks: filteredStocks,
      total_stocks: filteredStocks.length
    })
    
    if (!silent) {
      setLastUpdated(new Date().toLocaleString('zh-TW'))
    }
  }

  // ÁîüÊàêÊ®°Êì¨ËÇ°Á•®Êï∏Êìö
  const generateMockStocks = (): StockData[] => {
    const mockStocks = [
      { symbol: 'AAPL', name: 'Apple Inc.', base: 227.50, sector: 'Technology', exchange: 'NASDAQ' },
      { symbol: 'MSFT', name: 'Microsoft Corporation', base: 427.90, sector: 'Technology', exchange: 'NASDAQ' },
      { symbol: 'GOOGL', name: 'Alphabet Inc.', base: 175.80, sector: 'Technology', exchange: 'NASDAQ' },
      { symbol: 'TSLA', name: 'Tesla Inc.', base: 248.50, sector: 'Automotive', exchange: 'NASDAQ' },
      { symbol: 'NVDA', name: 'NVIDIA Corporation', base: 125.30, sector: 'Semiconductor', exchange: 'NASDAQ' },
      { symbol: 'AMZN', name: 'Amazon.com Inc.', base: 203.50, sector: 'E-commerce', exchange: 'NASDAQ' },
      { symbol: '2330.TW', name: 'Âè∞ÁÅ£Á©çÈ´îÈõªË∑Ø', base: 598.00, sector: 'Semiconductor', exchange: 'TWSE' },
      { symbol: '2454.TW', name: 'ËÅØÁôºÁßëÊäÄ', base: 1285.00, sector: 'Semiconductor', exchange: 'TWSE' },
      { symbol: '2317.TW', name: 'È¥ªÊµ∑Á≤æÂØÜ', base: 108.50, sector: 'Electronics', exchange: 'TWSE' },
      { symbol: '0700.HK', name: 'È®∞Ë®äÊéßËÇ°', base: 415.20, sector: 'Technology', exchange: 'HKSE' },
      { symbol: '0941.HK', name: '‰∏≠ÂúãÁßªÂãï', base: 58.30, sector: 'Telecom', exchange: 'HKSE' },
      { symbol: '1398.HK', name: 'Â∑•ÂïÜÈäÄË°å', base: 4.85, sector: 'Financial', exchange: 'HKSE' },
    ]

    return mockStocks.map(stock => {
      const changePercent = (Math.random() - 0.5) * 6 // ¬±3%
      const currentPrice = stock.base * (1 + changePercent / 100)
      const change = currentPrice - stock.base

      return {
        symbol: stock.symbol,
        name: stock.name,
        current_price: Number(currentPrice.toFixed(2)),
        change: Number(change.toFixed(2)),
        change_percent: Number(changePercent.toFixed(2)),
        volume: Math.floor(Math.random() * 50000000) + 10000000,
        sector: stock.sector,
        exchange: stock.exchange,
        data_source: 'Â¢ûÂº∑ÂûãÊ®°Êì¨Êï∏Êìö'
      }
    })
  }

  const getChangeColor = (change: number) => {
    if (change > 0) return 'text-green-600'
    if (change < 0) return 'text-red-600'
    return 'text-gray-600'
  }

  const getChangeIcon = (change: number) => {
    if (change > 0) return <TrendingUp className="w-4 h-4" />
    if (change < 0) return <TrendingDown className="w-4 h-4" />
    return <Activity className="w-4 h-4" />
  }

  const getMarketStatus = () => {
    if (!mounted) return { status: 'unknown', text: 'ËºâÂÖ•‰∏≠...', color: 'text-gray-600' }
    
    const now = new Date()
    const hour = now.getHours()
    const day = now.getDay()
    
    // Á∞°ÂåñÁöÑÂ∏ÇÂ†¥ÊôÇÈñìÂà§Êñ∑
    const isWeekday = day >= 1 && day <= 5
    const isMarketHours = hour >= 21 || hour <= 4 // UTC ÊôÇÈñì
    
    if (isWeekday && isMarketHours) {
      return { status: 'open', text: 'ÈñãÂ∏Ç', color: 'text-green-600' }
    } else {
      return { status: 'closed', text: '‰ºëÂ∏Ç', color: 'text-red-600' }
    }
  }

  const marketStatus = getMarketStatus()

  const getMarketSummary = () => {
    if (!marketData.stocks || marketData.stocks.length === 0) {
      return { gainers: 0, losers: 0, unchanged: 0 }
    }
    
    return marketData.stocks.reduce((acc, stock) => {
      if (stock.change_percent > 0.5) acc.gainers++
      else if (stock.change_percent < -0.5) acc.losers++
      else acc.unchanged++
      return acc
    }, { gainers: 0, losers: 0, unchanged: 0 })
  }

  const summary = getMarketSummary()

  // Â¶ÇÊûúÈÇÑÊ≤íÊúâ mountÔºåÈ°ØÁ§∫ loading
  if (!mounted) {
    return (
      <Layout>
        <div className="bg-gray-50 min-h-screen flex items-center justify-center">
          <div className="text-center">
            <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto mb-4"></div>
            <p className="text-gray-600">Ê≠£Âú®ÂàùÂßãÂåñÂ∏ÇÂ†¥Êï∏ÊìöÁ≥ªÁµ±...</p>
            <p className="text-xs text-gray-500 mt-2">Portfolio Insight v2.0</p>
          </div>
        </div>
      </Layout>
    )
  }

  if (loading) {
    return (
      <Layout>
        <div className="bg-gray-50 min-h-screen">
          <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
            <div className="text-center py-20">
              <div className="relative">
                <div className="animate-spin rounded-full h-20 w-20 border-b-4 border-blue-600 mx-auto mb-6"></div>
                <div className="absolute inset-0 flex items-center justify-center">
                  <div className="w-8 h-8 bg-blue-100 rounded-full animate-pulse"></div>
                </div>
              </div>
              <p className="text-gray-600 text-xl font-medium mb-2">ËºâÂÖ•Â∏ÇÂ†¥Á∏ΩË¶ΩÊï∏Êìö‰∏≠...</p>
              <p className="text-sm text-gray-500 mb-4">
                Ê≠£Âú®ÂæûÂ§öÂÄãÊï∏ÊìöÊ∫êÁç≤ÂèñÂÖ®ÁêÉËÇ°Â∏ÇÂç≥ÊôÇÊï∏Êìö
              </p>
              <div className="grid grid-cols-2 gap-4 text-xs text-gray-400 max-w-md mx-auto">
                <div className="bg-gray-100 p-3 rounded">
                  <div className="font-medium">API Á´ØÈªû</div>
                  <div className="truncate">{process.env.NEXT_PUBLIC_API_URL || 'http://localhost:8000'}</div>
                </div>
                <div className="bg-gray-100 p-3 rounded">
                  <div className="font-medium">ËºâÂÖ•ÊôÇÈñì</div>
                  <div>{currentTime}</div>
                </div>
              </div>
              
              {/* Ë™øË©¶‰ø°ÊÅØ */}
              {Object.keys(debugInfo).length > 0 && (
                <div className="mt-6 max-w-lg mx-auto">
                  <details className="text-left">
                    <summary className="cursor-pointer text-sm text-blue-600 hover:text-blue-800">
                      üîç È°ØÁ§∫Ë™øË©¶‰ø°ÊÅØ
                    </summary>
                    <pre className="mt-2 text-xs bg-gray-800 text-green-400 p-3 rounded overflow-auto max-h-40">
                      {JSON.stringify(debugInfo, null, 2)}
                    </pre>
                  </details>
                </div>
              )}
            </div>
          </div>
        </div>
      </Layout>
    )
  }

  return (
    <Layout>
      <div className="bg-gray-50 min-h-screen">
        <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
          {/* Header */}
          <div className="mb-8">
            <div className="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4">
              <div>
                <h1 className="text-3xl font-bold text-gray-900 mb-2">
                  üìà ÂÖ®ÁêÉËÇ°Â∏ÇÁ∏ΩË¶Ω
                </h1>
                <p className="text-gray-600">
                  Âç≥ÊôÇËÇ°Á•®Êï∏Êìö ‚Ä¢ ÂÖ®ÁêÉÂ∏ÇÂ†¥Áõ£Êéß ‚Ä¢ Â§öÂú∞ÂçÄËÇ°Â∏ÇÂàÜÊûê
                </p>
                <div className="mt-3 flex flex-wrap items-center gap-4 text-sm text-gray-500">
                  <span className="flex items-center">
                    <span className="w-2 h-2 bg-green-500 rounded-full mr-2"></span>
                    Êï∏Êìö‰æÜÊ∫ê: {marketData.data_source || 'Loading...'}
                  </span>
                  <span>|</span>
                  <span>Áî®Êà∂: <span className="font-semibold text-blue-600">JoyWuFN</span></span>
                  <span>|</span>
                  <span className={`font-medium ${marketStatus.color}`}>
                    Â∏ÇÂ†¥ÁãÄÊÖã: {marketStatus.text}
                  </span>
                  <span>|</span>
                  <span>Áï∂ÂâçÊôÇÈñì: {currentTime}</span>
                </div>
              </div>
              <div className="flex gap-2">
                <Button 
                  onClick={() => fetchMarketData()}
                  variant="secondary"
                  disabled={loading}
                  className="flex items-center"
                >
                  <RefreshCw className={`w-4 h-4 mr-2 ${loading ? 'animate-spin' : ''}`} />
                  ÊâãÂãïÂà∑Êñ∞
                </Button>
                <Button 
                  onClick={() => setAutoRefresh(!autoRefresh)}
                  variant={autoRefresh ? "primary" : "secondary"}
                  className="flex items-center"
                >
                  {autoRefresh ? (
                    <>
                      <span className="w-2 h-2 bg-green-400 rounded-full mr-2 animate-pulse"></span>
                      Ëá™ÂãïÂà∑Êñ∞
                    </>
                  ) : (
                    <>
                      <Activity className="w-4 h-4 mr-2" />
                      ÂïüÁî®Ëá™ÂãïÂà∑Êñ∞
                    </>
                  )}
                </Button>
                <Button href="/charts" variant="secondary">
                  üìä KÁ∑öÂúñË°®
                </Button>
              </div>
            </div>
            
            {/* Á≥ªÁµ±ÁãÄÊÖã‰ø°ÊÅØ */}
            <div className="mt-4 p-4 bg-gradient-to-r from-blue-50 to-indigo-50 border border-blue-200 rounded-lg">
              <div className="flex flex-wrap items-center justify-between gap-4 text-sm">
                <div className="flex flex-wrap items-center gap-4">
                  <span className="flex items-center">
                    <span className={`w-2 h-2 rounded-full mr-2 ${error ? 'bg-yellow-500' : 'bg-green-500'}`}></span>
                    ÂæåÁ´ØAPI: {error ? 'ÈôçÁ¥öÊ®°Âºè' : 'Ê≠£Â∏∏ÈÅãË°å'}
                  </span>
                  <span className="bg-blue-100 px-2 py-1 rounded">
                    Áï∂ÂâçÂú∞ÂçÄ: <span className="font-bold">
                      {regions.find(r => r.value === selectedRegion)?.flag} {regions.find(r => r.value === selectedRegion)?.label}
                    </span>
                  </span>
                  <span className="bg-green-100 px-2 py-1 rounded">
                    ËÇ°Á•®Êï∏Èáè: <span className="font-bold">{marketData.total_stocks || 0}</span>
                  </span>
                  <span className="bg-purple-100 px-2 py-1 rounded">
                    ÊéíÂ∫è: <span className="font-bold">
                      {sortBy === 'change_percent' ? 'Êº≤Ë∑åÂπÖ' : sortBy === 'volume' ? 'Êàê‰∫§Èáè' : '‰ª£Á¢º'}
                    </span>
                  </span>
                </div>
                {lastUpdated && (
                  <div className="flex items-center text-gray-600">
                    <span className="mr-2">üìÖ</span>
                    <span>ÊúÄÂæåÊõ¥Êñ∞: {lastUpdated}</span>
                    {autoRefresh && (
                      <span className="ml-2 text-green-600">(Ëá™ÂãïÂà∑Êñ∞‰∏≠)</span>
                    )}
                  </div>
                )}
              </div>
            </div>
          </div>

          {/* Error Display */}
          {error && (
            <div className="mb-6">
              <div className="bg-yellow-50 border border-yellow-200 rounded-lg p-4 shadow-sm">
                <div className="flex items-start">
                  <AlertCircle className="text-yellow-600 mr-3 mt-1" size={20} />
                  <div className="flex-1">
                    <h3 className="text-yellow-800 font-medium mb-2">‚ö†Ô∏è API ÈÄ£Êé•ÂïèÈ°å</h3>
                    <p className="text-yellow-700 text-sm mb-3">{error}</p>
                    <p className="text-yellow-600 text-xs mb-4">Ê≠£Âú®È°ØÁ§∫Â¢ûÂº∑ÂûãÊ®°Êì¨Êï∏ÊìöÔºåÂäüËÉΩÂèØËÉΩÂèóÈôê</p>
                    <div className="flex flex-wrap gap-2">
                      <Button 
                        onClick={() => fetchMarketData()}
                        size="sm"
                        variant="secondary"
                        disabled={loading}
                      >
                        üîÑ ÈáçÊñ∞ÂòóË©¶
                      </Button>
                      <Button 
                        onClick={() => setError(null)}
                        size="sm"
                        variant="secondary"
                      >
                        ‚úï ÈóúÈñâÊèêÁ§∫
                      </Button>
                    </div>
                    
                    {/* Ë™øË©¶‰ø°ÊÅØ */}
                    {Object.keys(debugInfo).length > 0 && (
                      <details className="mt-4">
                        <summary className="cursor-pointer text-sm text-yellow-700 hover:text-yellow-800">
                          üîç Ë™øË©¶‰ø°ÊÅØ
                        </summary>
                        <pre className="mt-2 text-xs bg-yellow-100 p-3 rounded overflow-auto max-h-40 text-yellow-800">
                          {JSON.stringify(debugInfo, null, 2)}
                        </pre>
                      </details>
                    )}
                  </div>
                </div>
              </div>
            </div>
          )}

          {/* Market Summary */}
          <div className="mb-6">
            <Card title="üìä Â∏ÇÂ†¥ÊëòË¶Å">
              <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
                <div className="text-center p-4 bg-gradient-to-br from-blue-50 to-blue-100 rounded-lg border">
                  <div className="text-2xl font-bold text-blue-600">
                    {marketData.total_stocks || 0}
                  </div>
                  <div className="text-sm text-gray-600 mt-1">ËøΩËπ§ËÇ°Á•®</div>
                </div>
                <div className="text-center p-4 bg-gradient-to-br from-green-50 to-green-100 rounded-lg border">
                  <div className="text-2xl font-bold text-green-600">
                    {summary.gainers}
                  </div>
                  <div className="text-sm text-gray-600 mt-1">‰∏äÊº≤ËÇ°Á•®</div>
                </div>
                <div className="text-center p-4 bg-gradient-to-br from-red-50 to-red-100 rounded-lg border">
                  <div className="text-2xl font-bold text-red-600">
                    {summary.losers}
                  </div>
                  <div className="text-sm text-gray-600 mt-1">‰∏ãË∑åËÇ°Á•®</div>
                </div>
                <div className="text-center p-4 bg-gradient-to-br from-gray-50 to-gray-100 rounded-lg border">
                  <div className="text-2xl font-bold text-gray-600">
                    {summary.unchanged}
                  </div>
                  <div className="text-sm text-gray-600 mt-1">ÊåÅÂπ≥ËÇ°Á•®</div>
                </div>
              </div>
            </Card>
          </div>

          {/* Controls */}
          <div className="mb-6">
            <Card title="üéõÔ∏è ÁØ©ÈÅ∏ËàáÊéíÂ∫èÊéßÂà∂">
              <div className="flex flex-wrap gap-4 items-center">
                {/* Âú∞ÂçÄÁØ©ÈÅ∏ */}
                <div className="flex flex-wrap gap-2">
                  <span className="text-sm font-medium text-gray-700 self-center mr-2">Âú∞ÂçÄ:</span>
                  {regions.map((region) => (
                    <button
                      key={region.value}
                      onClick={() => setSelectedRegion(region.value)}
                      className={`px-3 py-2 rounded-lg text-sm font-medium transition-all duration-200 ${
                        selectedRegion === region.value 
                          ? 'bg-blue-600 text-white shadow-lg' 
                          : 'bg-white text-gray-700 border border-gray-200 hover:bg-blue-50 hover:border-blue-300'
                      }`}
                    >
                      {region.flag} {region.label}
                    </button>
                  ))}
                </div>

                <div className="border-l border-gray-300 h-8"></div>

                {/* ÊéíÂ∫èÊéßÂà∂ */}
                <div className="flex flex-wrap gap-2">
                  <span className="text-sm font-medium text-gray-700 self-center mr-2">ÊéíÂ∫è:</span>
                  <select
                    value={sortBy}
                    onChange={(e) => setSortBy(e.target.value as any)}
                    className="px-3 py-2 border border-gray-300 rounded-lg text-sm"
                  >
                    <option value="change_percent">Êº≤Ë∑åÂπÖ</option>
                    <option value="volume">Êàê‰∫§Èáè</option>
                    <option value="symbol">ËÇ°Á•®‰ª£Á¢º</option>
                  </select>
                  <button
                    onClick={() => setSortOrder(sortOrder === 'asc' ? 'desc' : 'asc')}
                    className="px-3 py-2 border border-gray-300 rounded-lg text-sm hover:bg-gray-50"
                  >
                    {sortOrder === 'desc' ? '‚¨áÔ∏è ÈôçÂ∫è' : '‚¨ÜÔ∏è ÂçáÂ∫è'}
                  </button>
                </div>
              </div>
            </Card>
          </div>

          {/* Stock Grid */}
          <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
            {marketData.stocks?.map((stock) => (
              <div
                key={stock.symbol}
                className="bg-white rounded-lg shadow-md p-6 hover:shadow-lg transition-all duration-200 border hover:border-blue-300 cursor-pointer"
                onClick={() => window.open(`/charts?symbol=${stock.symbol}`, '_blank')}
              >
                <div className="flex justify-between items-start mb-4">
                  <div className="flex-1">
                    <h3 className="text-lg font-semibold text-gray-900 mb-1">
                      {stock.symbol}
                    </h3>
                    <p className="text-sm text-gray-600 truncate mb-2">{stock.name}</p>
                    <div className="flex items-center gap-2 text-xs">
                      {stock.exchange && (
                        <span className="bg-gray-100 px-2 py-1 rounded">{stock.exchange}</span>
                      )}
                      {stock.sector && (
                        <span className="bg-blue-100 text-blue-800 px-2 py-1 rounded">{stock.sector}</span>
                      )}
                    </div>
                  </div>
                  <div className={`flex items-center ${getChangeColor(stock.change)}`}>
                    {getChangeIcon(stock.change)}
                  </div>
                </div>

                <div className="space-y-3">
                  <div className="flex justify-between items-center">
                    <span className="text-2xl font-bold text-gray-900">
                      ${stock.current_price.toFixed(2)}
                    </span>
                    <div className={`text-right ${getChangeColor(stock.change)}`}>
                      <div className="font-semibold text-sm">
                        {stock.change >= 0 ? '+' : ''}{stock.change.toFixed(2)}
                      </div>
                      <div className="text-xs">
                        ({stock.change_percent >= 0 ? '+' : ''}{stock.change_percent.toFixed(2)}%)
                      </div>
                    </div>
                  </div>

                  <div className="flex justify-between text-xs text-gray-600">
                    <span>Êàê‰∫§Èáè</span>
                    <span>{(stock.volume / 1000000).toFixed(1)}M</span>
                  </div>

                  {stock.data_source && (
                    <div className="text-xs text-gray-500 pt-2 border-t">
                      Êï∏Êìö‰æÜÊ∫ê: {stock.data_source}
                    </div>
                  )}
                </div>

                {/* ÈªûÊìäÊèêÁ§∫ */}
                <div className="mt-4 pt-3 border-t border-gray-100">
                  <p className="text-xs text-blue-600 text-center">
                    üîç ÈªûÊìäÊü•Áúã K Á∑öÂúñË°®
                  </p>
                </div>
              </div>
            ))}
          </div>

          {/* ÁÑ°Êï∏ÊìöÊèêÁ§∫ */}
          {(!marketData.stocks || marketData.stocks.length === 0) && !loading && (
            <div className="text-center py-12">
              <BarChart3 className="mx-auto h-12 w-12 text-gray-400 mb-4" />
              <h3 className="text-lg font-medium text-gray-900 mb-2">Êö´ÁÑ°Â∏ÇÂ†¥Êï∏Êìö</h3>
              <p className="text-sm text-gray-500 mb-6">
                ÊâÄÈÅ∏Âú∞ÂçÄÊ≤íÊúâÂèØÁî®ÁöÑËÇ°Á•®Êï∏ÊìöÔºåË´ãÂòóË©¶ÂÖ∂‰ªñÂú∞ÂçÄÊàñÊ™¢Êü•Á∂≤Áµ°ÈÄ£Êé•
              </p>
              <div className="flex justify-center gap-4">
                <Button onClick={() => fetchMarketData()}>
                  üîÑ ÈáçÊñ∞ËºâÂÖ•
                </Button>
                <Button onClick={() => setSelectedRegion('ALL')} variant="secondary">
                  üåç Êü•ÁúãÂÖ®ÈÉ®Â∏ÇÂ†¥
                </Button>
              </div>
            </div>
          )}

          {/* Footer Info */}
          <div className="mt-8 text-center text-sm text-gray-500">
            <div className="border-t pt-4">
              <p>
                üìà Portfolio Insight - ÂÖ®ÁêÉËÇ°Â∏ÇÁ∏ΩË¶ΩÁ≥ªÁµ± | 
                Áî®Êà∂: <span className="font-semibold text-blue-600">JoyWuFN</span> | 
                Êï∏Êìö‰æÜÊ∫ê: Alpha Vantage API + Enhanced Mock Data | 
                Á≥ªÁµ±ÊôÇÈñì: {currentTime}
              </p>
              <p className="text-xs text-gray-400 mt-2">
                ÂÖçË≤¨ËÅ≤Êòé: Êú¨Á≥ªÁµ±Êèê‰æõÁöÑËÇ°Á•®Êï∏ÊìöÂíåÂàÜÊûêÂÉÖ‰æõÂèÉËÄÉÔºå‰∏çÊßãÊàêÊäïË≥áÂª∫Ë≠∞„ÄÇÊäïË≥áÊúâÈ¢®Èö™ÔºåË´ãË¨πÊÖéÊ±∫Á≠ñ„ÄÇ
              </p>
            </div>
          </div>
        </div>
      </div>
    </Layout>
  )
}